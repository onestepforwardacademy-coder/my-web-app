# scanner.py
# Playwright (Stable Fix) + OCR + Dexscreener search utilities + SQLite Integration

import time
import re
import requests
import os
import sqlite3
from datetime import datetime, timezone
from PIL import Image as PILImage, ImageEnhance
import pytesseract
from typing import List, Tuple, Optional, Dict

# Switch to Playwright for the "Forever Fix"
from playwright.sync_api import sync_playwright

# Database configuration
DB_PATH = "scanner_data.db"

# ----- memory helpers -----
def init_db():
    """Initializes the database and table if they do not exist."""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS seen_pairs 
        (pair_address TEXT PRIMARY KEY, timestamp DATETIME DEFAULT CURRENT_TIMESTAMP)
    ''')
    conn.commit()
    conn.close()

def load_seen_pairs() -> set:
    init_db()
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("SELECT pair_address FROM seen_pairs")
        rows = cursor.fetchall()
        conn.close()
        return set(row[0] for row in rows)
    except Exception as e:
        print(f"‚ùå Database Error: {e}")
        return set()

def save_seen_pair(pair_address: str) -> None:
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("INSERT OR IGNORE INTO seen_pairs (pair_address) VALUES (?)", (pair_address,))
        conn.commit()
        conn.close()
    except Exception as e:
        print(f"‚ùå Database Save Error: {e}")

# ----- formatting -----
def format_age_dynamic(created_timestamp_ms: int) -> str:
    created_dt = datetime.fromtimestamp(created_timestamp_ms / 1000, tz=timezone.utc)
    now = datetime.now(timezone.utc)
    delta = now - created_dt
    total_minutes = int(delta.total_seconds() // 60)
    if total_minutes < 60: return f"{total_minutes}m"
    total_hours = total_minutes // 60
    minutes = total_minutes % 60
    if total_hours < 24: return f"{total_hours}h {minutes}m"
    total_days = total_hours // 24
    hours = total_hours % 24
    if total_days < 30: return f"{total_days}d {hours}h"
    total_months = total_days // 30
    days = total_days % 30
    if total_months < 12: return f"{total_months}m {days}d"
    years = total_months // 12
    months = total_months % 12
    return f"{years}y {months}m"

# ----- Dexscreener profile fetch -----
def get_profile_info(token_mint: str) -> Optional[Dict]:
    url = f"https://api.dexscreener.com/latest/dex/search?q={token_mint}"
    try:
        response = requests.get(url, timeout=10)
        data = response.json()
    except Exception:
        return None

    pairs = data.get("pairs")
    if not pairs: return None

    pair = pairs[0]
    info = pair.get("info", {})
    return {
        "token_name": pair.get("baseToken", {}).get("name", "Unknown"),
        "token_symbol": pair.get("baseToken", {}).get("symbol", ""),
        "pair_url": pair.get("url"),
        "image": info.get("imageUrl"),
        "socials": info.get("socials")
    }

# ----- Collector -----
new_pairs_to_buy: List[str] = []

def collect_new_pair(token_mint: str) -> None:
    if token_mint not in new_pairs_to_buy:
        new_pairs_to_buy.append(token_mint)

# ----- Dexscreener search -----
def search_solana_by_mint(token_mint: str) -> None:
    print(f"üîç Searching API for: {token_mint}...")
    url = f"https://api.dexscreener.com/latest/dex/search?q={token_mint}"
    try:
        r = requests.get(url, timeout=10)
        r.raise_for_status()
        data = r.json()
    except Exception as e:
        print(f"‚ùå API Error for {token_mint}: {e}")
        return

    pairs = data.get("pairs", [])
    sol_pairs = [p for p in pairs if p.get("chainId") == "solana"]
    pump_pairs = [p for p in sol_pairs if p.get("dexId") == "pumpswap"]

    if not pump_pairs:
        print(f"‚ÑπÔ∏è No pump.fun pairs found for {token_mint}")
        return

    seen_pairs = load_seen_pairs()

    for i, p in enumerate(pump_pairs, 1):
        pair_address = p.get("pairAddress")
        token_mint_addr = p.get("baseToken", {}).get("address")
        
        if pair_address in seen_pairs:
            print(f"‚ôªÔ∏è {token_mint_addr} - Already seen.")
            continue

        profile = get_profile_info(token_mint_addr)
        if profile:
            print(f"üÜï NEW TOKEN DETECTED: {profile['token_symbol']}")
            save_seen_pair(pair_address)
            collect_new_pair(token_mint_addr)
            print(f"   Mint: {token_mint_addr}\n   URL: {p.get('url')}\n")

# ----- Playwright Engine -----
def run_selenium_screenshot(
    screenshot_path: str = "dexscreener_scan.png",
    headless: bool = True
) -> str:
    print("üöÄ Launching Browser...")
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=headless, args=["--no-sandbox"])
        context = browser.new_context(viewport={'width': 1920, 'height': 1080})
        page = context.new_page()

        try:
            url = "https://dexscreener.com/?rankBy=pairAge&order=asc&chainIds=solana&dexIds=pumpswap,pumpfun&maxAge=2&profile=1"
            print(f"üåê Navigating to Dexscreener...")
            page.goto(url, wait_until="domcontentloaded", timeout=45000)
            
            print("‚è≥ Waiting for table data...")
            page.wait_for_timeout(8000)

            print("üì∏ Taking Screenshot...")
            page.screenshot(path=screenshot_path, full_page=False)
            print(f"‚úÖ Screenshot saved: {screenshot_path}")

        except Exception as e:
            print(f"‚ùå Playwright Error: {e}")
        finally:
            browser.close()
    return screenshot_path

def ocr_extract_pair_symbols(screenshot_path: str) -> List[str]:
    print("üñºÔ∏è Starting OCR extraction...")
    img = PILImage.open(screenshot_path)
    img = img.convert('L').resize((img.width*2, img.height*2))
    img = ImageEnhance.Contrast(img).enhance(2.0)

    text = pytesseract.image_to_string(img)
    if not text.strip():
        print("‚ö†Ô∏è OCR Warning: No text found in screenshot. Check if the page loaded.")
        return []

    lines = text.splitlines()
    pair_symbols: List[str] = []
    pattern = re.compile(r'([A-Za-z0-9]+)\s*/')

    for line in lines:
        matches = pattern.findall(line.strip())
        for match in matches:
            pair_symbols.append(match.upper())

    pair_symbols = list(dict.fromkeys(pair_symbols))
    print(f"‚úÖ OCR found symbols: {pair_symbols}")
    return pair_symbols

def run_scan_and_search() -> List[str]:
    global new_pairs_to_buy
    new_pairs_to_buy = []
    
    print(f"\n--- SCAN START: {datetime.now().strftime('%H:%M:%S')} ---")
    shot = run_selenium_screenshot()
    pair_symbols = ocr_extract_pair_symbols(shot)
    
    if not pair_symbols:
        print("‚ùå No symbols to search. Ending scan.")
        return []

    for token in pair_symbols:
        search_solana_by_mint(token)

    print(f"--- SCAN COMPLETE ---\n")
    return pair_symbols

if __name__ == "__main__":
    run_scan_and_search()
